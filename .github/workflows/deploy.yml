name: "Build & Deploy to EC2"

on:
  workflow_dispatch:
    inputs:
      BRANCH_TO_BUILD:
        description: 'Branch to build (develop, feature, wip, sprint)'
        required: true
        default: 'main'

env:
  IMAGE_NAME: grokking-be
  EC2_HOST: 3.6.105.82
  EC2_USER: ubuntu
  CONTAINER_NAME: grokking-be
  CONTAINER_PORT: 8000
  ADDITIONAL_PORT: 15500
  REPO_URL: ${{ github.server_url }}/${{ github.repository }}.git

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Get Git metadata
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          echo "TIMESTAMP=${TIMESTAMP}" >> $GITHUB_ENV
          echo "IMAGE_TAG=${TIMESTAMP}" >> $GITHUB_ENV

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          
          # Decode Base64 encoded SSH key
          echo "${{ secrets.EC2_SSH_KEY_B64 }}" | base64 -d > ~/.ssh/grokking.pem
          
          chmod 600 ~/.ssh/grokking.pem
          ssh-keyscan -H ${{ env.EC2_HOST }} >> ~/.ssh/known_hosts
          
          # Verify key format
          echo "üîë Verifying SSH key..."
          head -1 ~/.ssh/grokking.pem
          tail -1 ~/.ssh/grokking.pem
          ssh-keygen -l -f ~/.ssh/grokking.pem

      - name: Build and Deploy on EC2
        run: |
          ssh -T -o StrictHostKeyChecking=no -i ~/.ssh/grokking.pem ${{ env.EC2_USER }}@${{ env.EC2_HOST }} << 'ENDSSH'
            set -e
            
            echo "üìÅ Setting up build directory..."
            BUILD_DIR="/tmp/grokking-be-build"
            rm -rf $BUILD_DIR
            mkdir -p $BUILD_DIR
            cd $BUILD_DIR
            
            echo "üì• Cloning repository..."
            git clone --depth 1 --branch ${{ github.event.inputs.BRANCH_TO_BUILD }} ${{ env.REPO_URL }} .
            
            echo "üî® Building Docker image..."
            docker build -t ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
                         -t ${{ env.IMAGE_NAME }}:latest .
            
            echo "üõë Stopping existing container (if any)..."
            docker stop ${{ env.CONTAINER_NAME }} 2>/dev/null || true
            docker rm ${{ env.CONTAINER_NAME }} 2>/dev/null || true
            
            echo "üöÄ Starting new container with .env..."
            docker run -d \
              --name ${{ env.CONTAINER_NAME }} \
              --restart unless-stopped \
              --env-file /home/ubuntu/grokking-be/.env \
              -p ${{ env.CONTAINER_PORT }}:${{ env.CONTAINER_PORT }} \
              -p ${{ env.ADDITIONAL_PORT }}:${{ env.ADDITIONAL_PORT }} \
              ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            
            echo "‚úÖ Container started successfully!"
            docker ps | grep ${{ env.CONTAINER_NAME }}
            
            echo "‚è≥ Waiting for container to be ready..."
            sleep 5
            
            echo "üß™ Running promptfoo evaluations..."
            docker exec ${{ env.CONTAINER_NAME }} npm run promptfoo:eval:planner || echo "‚ö†Ô∏è planner eval failed or not available"
            docker exec ${{ env.CONTAINER_NAME }} npm run promptfoo:eval:executor || echo "‚ö†Ô∏è executor eval failed or not available"
            
            echo "üëÄ Starting promptfoo view (background on port 15500)..."
            docker exec -d ${{ env.CONTAINER_NAME }} npm run promptfoo:view || echo "‚ö†Ô∏è promptfoo view failed or not available"
            
            echo "üßπ Cleaning up..."
            rm -rf $BUILD_DIR
            docker image prune -f
          ENDSSH

      - name: Cleanup SSH Key
        if: always()
        run: rm -f ~/.ssh/grokking.pem

      - name: Notify
        run: |
          echo "‚úÖ Built from branch: ${{ github.event.inputs.BRANCH_TO_BUILD }}"
          echo "‚úÖ Timestamp: ${{ env.TIMESTAMP }}"
          echo "‚úÖ Image tag: ${{ env.IMAGE_TAG }}"
          echo "üöÄ Deployed to EC2: ${{ env.EC2_USER }}@${{ env.EC2_HOST }}"
          echo "üîó Application URL: http://${{ env.EC2_HOST }}:${{ env.CONTAINER_PORT }}"
