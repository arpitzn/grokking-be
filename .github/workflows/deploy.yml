name: "Build & Deploy to EC2"

on:
  workflow_dispatch:
    inputs:
      BRANCH_TO_BUILD:
        description: 'Branch to build (develop, feature, wip, sprint)'
        required: true
        default: 'main'

env:
  IMAGE_NAME: grokking-be
  EC2_HOST: 3.6.105.82
  EC2_USER: ubuntu
  CONTAINER_NAME: grokking-be
  CONTAINER_PORT: 8000
  REPO_URL: ${{ github.server_url }}/${{ github.repository }}.git

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Get Git metadata
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          echo "TIMESTAMP=${TIMESTAMP}" >> $GITHUB_ENV
          echo "IMAGE_TAG=${TIMESTAMP}" >> $GITHUB_ENV

      - name: Setup SSH Key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          
          # Write key using printf to preserve formatting
          printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/grokking.pem
          
          # Remove Windows line endings if present
          sed -i 's/\r$//' ~/.ssh/grokking.pem
          
          chmod 600 ~/.ssh/grokking.pem
          ssh-keyscan -H ${{ env.EC2_HOST }} >> ~/.ssh/known_hosts
          
          # Verify key format
          echo "ðŸ”‘ Verifying SSH key format..."
          echo "First line: $(head -1 ~/.ssh/grokking.pem)"
          echo "Last line: $(tail -1 ~/.ssh/grokking.pem)"
          echo "Line count: $(wc -l < ~/.ssh/grokking.pem)"
          
          # Test key validity
          ssh-keygen -l -f ~/.ssh/grokking.pem || echo "âš ï¸ Key validation failed"

      - name: Build and Deploy on EC2
        run: |
          ssh -T -o StrictHostKeyChecking=no -i ~/.ssh/grokking.pem ${{ env.EC2_USER }}@${{ env.EC2_HOST }} << 'ENDSSH'
            set -e
            
            echo "ðŸ“ Setting up build directory..."
            BUILD_DIR="/tmp/grokking-be-build"
            rm -rf $BUILD_DIR
            mkdir -p $BUILD_DIR
            cd $BUILD_DIR
            
            echo "ðŸ“¥ Cloning repository..."
            git clone --depth 1 --branch ${{ github.event.inputs.BRANCH_TO_BUILD }} ${{ env.REPO_URL }} .
            
            echo "ðŸ”¨ Building Docker image..."
            docker build -t ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
                         -t ${{ env.IMAGE_NAME }}:latest .
            
            echo "ðŸ›‘ Stopping existing container (if any)..."
            docker stop ${{ env.CONTAINER_NAME }} 2>/dev/null || true
            docker rm ${{ env.CONTAINER_NAME }} 2>/dev/null || true
            
            echo "ðŸš€ Starting new container..."
            docker run -d \
              --name ${{ env.CONTAINER_NAME }} \
              --restart unless-stopped \
              -p ${{ env.CONTAINER_PORT }}:${{ env.CONTAINER_PORT }} \
              ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            
            echo "âœ… Container started successfully!"
            docker ps | grep ${{ env.CONTAINER_NAME }}
            
            echo "ðŸ§¹ Cleaning up..."
            rm -rf $BUILD_DIR
            docker image prune -f
          ENDSSH

      - name: Cleanup SSH Key
        if: always()
        run: rm -f ~/.ssh/grokking.pem

      - name: Notify
        run: |
          echo "âœ… Built from branch: ${{ github.event.inputs.BRANCH_TO_BUILD }}"
          echo "âœ… Timestamp: ${{ env.TIMESTAMP }}"
          echo "âœ… Image tag: ${{ env.IMAGE_TAG }}"
          echo "ðŸš€ Deployed to EC2: ${{ env.EC2_USER }}@${{ env.EC2_HOST }}"
          echo "ðŸ”— Application URL: http://${{ env.EC2_HOST }}:${{ env.CONTAINER_PORT }}"
