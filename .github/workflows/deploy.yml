name: "Build & Deploy to EC2"

on:
  workflow_dispatch:
    inputs:
      BRANCH_TO_BUILD:
        description: 'Branch to build (develop, feature, wip, sprint)'
        required: true
        default: 'main'

env:
  IMAGE_NAME: grokking-be
  EC2_HOST: 3.6.105.82
  EC2_USER: ubuntu
  CONTAINER_NAME: grokking-be
  CONTAINER_PORT: 8000
  ADDITIONAL_PORT: 15500
  REPO_URL: ${{ github.server_url }}/${{ github.repository }}.git

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Get Git metadata
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          echo "TIMESTAMP=${TIMESTAMP}" >> $GITHUB_ENV
          echo "IMAGE_TAG=${TIMESTAMP}" >> $GITHUB_ENV

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          
          # Decode Base64 encoded SSH key
          echo "${{ secrets.EC2_SSH_KEY_B64 }}" | base64 -d > ~/.ssh/grokking.pem
          
          chmod 600 ~/.ssh/grokking.pem
          ssh-keyscan -H ${{ env.EC2_HOST }} >> ~/.ssh/known_hosts
          
          # Verify key format
          echo "ðŸ”‘ Verifying SSH key..."
          head -1 ~/.ssh/grokking.pem
          tail -1 ~/.ssh/grokking.pem
          ssh-keygen -l -f ~/.ssh/grokking.pem

      - name: Build and Deploy on EC2
        run: |
          ssh -T -o StrictHostKeyChecking=no -i ~/.ssh/grokking.pem ${{ env.EC2_USER }}@${{ env.EC2_HOST }} << 'ENDSSH'
            set -e
            
            echo "ðŸ“ Setting up build directory..."
            BUILD_DIR="/tmp/grokking-be-build"
            rm -rf $BUILD_DIR
            mkdir -p $BUILD_DIR
            cd $BUILD_DIR
            
            echo "ðŸ“¥ Cloning repository..."
            git clone --depth 1 --branch ${{ github.event.inputs.BRANCH_TO_BUILD }} ${{ env.REPO_URL }} .
            
            echo "ðŸ”¨ Building Docker image..."
            docker build -t ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
                         -t ${{ env.IMAGE_NAME }}:latest .
            
            echo "ðŸ›‘ Stopping existing container (if any)..."
            docker stop ${{ env.CONTAINER_NAME }} 2>/dev/null || true
            docker rm ${{ env.CONTAINER_NAME }} 2>/dev/null || true
            
            echo "ðŸš€ Starting new container with .env..."
            docker run -d \
              --name ${{ env.CONTAINER_NAME }} \
              --restart unless-stopped \
              --env-file /home/ubuntu/grokking-be/.env \
              -p ${{ env.CONTAINER_PORT }}:${{ env.CONTAINER_PORT }} \
              -p ${{ env.ADDITIONAL_PORT }}:${{ env.ADDITIONAL_PORT }} \
              ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            
            echo "âœ… Container started successfully!"
            docker ps | grep ${{ env.CONTAINER_NAME }}
            
            echo "ðŸ§¹ Cleaning up build directory..."
            cd /home/ubuntu
            rm -rf $BUILD_DIR
            docker image prune -f
            
            echo "â³ Waiting for container to be ready..."
            sleep 5
            
            echo "ðŸ§ª Setting up promptfoo on host..."
            REPO_DIR="/home/ubuntu/grokking-be/repo"
            
            # Clone or update the repo for promptfoo
            if [ -d "$REPO_DIR" ]; then
              echo "ðŸ“¥ Updating existing repo directory..."
              cd $REPO_DIR && git fetch origin && git reset --hard origin/${{ github.event.inputs.BRANCH_TO_BUILD }} || true
            else
              echo "ðŸ“¥ Cloning repo for promptfoo..."
              mkdir -p /home/ubuntu/grokking-be
              git clone --depth 1 --branch ${{ github.event.inputs.BRANCH_TO_BUILD }} ${{ env.REPO_URL }} $REPO_DIR
            fi
            
            cd $REPO_DIR
            
            # Install dependencies if needed
            if [ ! -d "node_modules" ]; then
              echo "ðŸ“¦ Installing npm dependencies..."
              npm install
            fi
            
            echo "â–¶ï¸ Running planner evaluation..."
            npm run promptfoo:eval:planner || echo "âš ï¸ planner eval failed"
            
            echo "â–¶ï¸ Running executor evaluation..."
            npm run promptfoo:eval:executor || echo "âš ï¸ executor eval failed"
            
            echo "ðŸ‘€ Starting promptfoo view (background on port 15500)..."
            # Kill any existing promptfoo view process
            pkill -f "promptfoo view" || true
            nohup npm run promptfoo:view > /tmp/promptfoo-view.log 2>&1 &
            echo "âœ… promptfoo view started on port 15500"
          ENDSSH

      - name: Cleanup SSH Key
        if: always()
        run: rm -f ~/.ssh/grokking.pem

      - name: Notify
        run: |
          echo "âœ… Built from branch: ${{ github.event.inputs.BRANCH_TO_BUILD }}"
          echo "âœ… Timestamp: ${{ env.TIMESTAMP }}"
          echo "âœ… Image tag: ${{ env.IMAGE_TAG }}"
          echo "ðŸš€ Deployed to EC2: ${{ env.EC2_USER }}@${{ env.EC2_HOST }}"
          echo "ðŸ”— Application URL: http://${{ env.EC2_HOST }}:${{ env.CONTAINER_PORT }}"
